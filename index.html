<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üîê –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI Emoji', sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.4;
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
        .container {
            max-width: 100%;
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-top: 8px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .header .subtitle {
            color: var(--tg-theme-hint-color, #707579);
            font-size: 14px;
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .categories {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-btn {
            padding: 10px 20px;
            border-radius: 20px;
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            color: var(--tg-theme-text-color, #000000);
            border: none;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .category-btn.active {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–∞—Ä–æ–ª–µ–π */
        .password-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 80px;
        }

        .password-card {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border-radius: 16px;
            padding: 18px;
            border: 1px solid var(--tg-theme-hint-color, rgba(0, 0, 0, 0.1));
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .password-card:active {
            transform: scale(0.98);
        }

        .password-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .service-name {
            font-size: 17px;
            font-weight: 600;
            color: var(--tg-theme-text-color, #000000);
        }

        .category-badge {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .password-field {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--tg-theme-hint-color, #e5e5e5);
        }

        .field-label {
            display: block;
            font-size: 13px;
            color: var(--tg-theme-hint-color, #707579);
            margin-bottom: 6px;
        }

        .field-value {
            font-size: 16px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #000000);
            word-break: break-all;
        }

        .password-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--tg-theme-button-color, #2481cc);
            background: transparent;
            color: var(--tg-theme-button-color, #2481cc);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn.copy {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--tg-theme-hint-color, #e5e5e5);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .select-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--tg-theme-hint-color, #e5e5e5);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='%23707579' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 20px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            color: var(--tg-theme-text-color, #000000);
        }

        /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
        .add-btn-container {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 100;
        }

        .add-btn {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 28px;
            padding: 16px 32px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(36, 129, 204, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s;
        }

        .add-btn:active {
            transform: scale(0.95);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            text-align: center;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* –ú–µ–Ω—é —ç–∫—Å–ø–æ—Ä—Ç–∞ */
        .export-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
        }

        .export-btn {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            color: var(--tg-theme-text-color, #000000);
            transition: transform 0.2s;
        }

        .export-btn:active {
            transform: scale(0.9);
        }

        .export-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 12px;
            padding: 8px;
            margin-top: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            min-width: 180px;
            border: 1px solid var(--tg-theme-hint-color, #e5e5e5);
        }

        .export-dropdown.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .export-option {
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            background: none;
            color: var(--tg-theme-text-color, #000000);
            font-size: 15px;
            text-align: left;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
        }

        .export-option:hover,
        .export-option:active {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }

        /* –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--tg-theme-hint-color, #707579);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 16px;
            margin-bottom: 24px;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è iOS */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
        }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        @media (prefers-color-scheme: dark) {
            :root {
                --tg-theme-bg-color: #1c1c1e;
                --tg-theme-text-color: #ffffff;
                --tg-theme-secondary-bg-color: #2c2c2e;
                --tg-theme-hint-color: #48484a;
                --tg-theme-button-color: #0a84ff;
                --tg-theme-button-text-color: #ffffff;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π</h1>
            <div class="subtitle">–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
        </div>

        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div class="categories" id="categories">
            <button class="category-btn active" data-category="all">–í—Å–µ</button>
            <button class="category-btn" data-category="social">–°–æ—Ü—Å–µ—Ç–∏</button>
            <button class="category-btn" data-category="email">–ü–æ—á—Ç–∞</button>
            <button class="category-btn" data-category="games">–ò–≥—Ä—ã</button>
            <button class="category-btn" data-category="finance">–§–∏–Ω–∞–Ω—Å—ã</button>
            <button class="category-btn" data-category="work">–†–∞–±–æ—Ç–∞</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–∞—Ä–æ–ª–µ–π -->
        <div class="password-list" id="passwordList">
            <!-- –ü–∞—Ä–æ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üîê</div>
            <div class="empty-text">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π</div>
            <button class="btn btn-primary" onclick="showAddForm()">
                <span>+</span> –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –ø–∞—Ä–æ–ª—å
            </button>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <div class="add-btn-container">
        <button class="add-btn" onclick="showAddForm()">
            <span>+</span> –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å
        </button>
    </div>

    <!-- –ú–µ–Ω—é —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
    <div class="export-menu">
        <button class="export-btn" onclick="toggleExportMenu()">‚¨áÔ∏è</button>
        <div class="export-dropdown" id="exportDropdown">
            <button class="export-option" onclick="exportEncrypted()">
                <span>üîí</span> –≠–∫—Å–ø–æ—Ä—Ç —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
            </button>
            <button class="export-option" onclick="exportUnencrypted()">
                <span>üìÑ</span> –≠–∫—Å–ø–æ—Ä—Ç –±–µ–∑ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
            </button>
            <button class="export-option" onclick="showStats()">
                <span>üìä</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <h2 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</h2>
            <form id="passwordForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞</label>
                    <input type="text" class="form-input" id="serviceName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Gmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–õ–æ–≥–∏–Ω / Email</label>
                    <input type="text" class="form-input" id="username" placeholder="–í–∞—à –ª–æ–≥–∏–Ω" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" class="form-input" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="generatePassword()" style="flex-shrink: 0; padding: 0 15px;">
                            üé≤
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select class="select-input" id="category">
                        <option value="social">–°–æ—Ü—Å–µ—Ç–∏</option>
                        <option value="email">–ü–æ—á—Ç–∞</option>
                        <option value="games">–ò–≥—Ä—ã</option>
                        <option value="finance">–§–∏–Ω–∞–Ω—Å—ã</option>
                        <option value="work">–†–∞–±–æ—Ç–∞</option>
                        <option value="other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">URL —Å–∞–π—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="url" class="form-input" id="url" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">–ó–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <textarea class="form-input" id="notes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" rows="3"></textarea>
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="hideAddForm()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.hide();

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–æ–≤–æ–π —Ç–µ–º—ã
        document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f4f4f5');
        document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#707579');
        document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
        document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');

        // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
        class PasswordManagerDB {
            constructor() {
                this.db = null;
                this.dbName = 'PasswordManagerDB';
                this.storeName = 'passwords';
                this.initialized = false;
            }

            async init() {
                if (this.initialized) return Promise.resolve();
                
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 2);
                    
                    request.onerror = (event) => {
                        console.error('IndexedDB error:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        this.initialized = true;
                        console.log('IndexedDB initialized successfully');
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        console.log('Upgrading IndexedDB database');
                        
                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        if (db.objectStoreNames.contains(this.storeName)) {
                            db.deleteObjectStore(this.storeName);
                        }
                        
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                        const store = db.createObjectStore(this.storeName, { 
                            keyPath: 'id',
                            autoIncrement: true 
                        });
                        
                        // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('service', 'service', { unique: false });
                        store.createIndex('createdAt', 'createdAt', { unique: false });
                    };
                });
            }

            async savePassword(passwordData) {
                await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    
                    const data = {
                        ...passwordData,
                        id: Date.now() + Math.random(),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    const request = store.add(data);
                    
                    request.onerror = (event) => {
                        console.error('Error saving password:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    request.onsuccess = () => {
                        console.log('Password saved successfully:', data.id);
                        resolve(data);
                    };
                });
            }

            async getPasswords(category = 'all') {
                await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();
                    
                    request.onerror = (event) => {
                        console.error('Error getting passwords:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    request.onsuccess = (event) => {
                        let passwords = event.target.result || [];
                        
                        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        if (category !== 'all') {
                            passwords = passwords.filter(p => p.category === category);
                        }
                        
                        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
                        passwords.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        
                        resolve(passwords);
                    };
                });
            }

            async deletePassword(id) {
                await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(id);
                    
                    request.onerror = (event) => reject(event.target.error);
                    request.onsuccess = () => resolve();
                });
            }

            async updatePassword(id, updates) {
                await this.init();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    
                    const getRequest = store.get(id);
                    
                    getRequest.onerror = (event) => reject(event.target.error);
                    
                    getRequest.onsuccess = (event) => {
                        const data = event.target.result;
                        if (!data) {
                            reject(new Error('Password not found'));
                            return;
                        }
                        
                        const updatedData = {
                            ...data,
                            ...updates,
                            updatedAt: new Date().toISOString()
                        };
                        
                        const updateRequest = store.put(updatedData);
                        
                        updateRequest.onerror = (event) => reject(event.target.error);
                        updateRequest.onsuccess = () => resolve(updatedData);
                    };
                });
            }

            async getStats() {
                const passwords = await this.getPasswords('all');
                const categories = {};
                let totalStrength = 0;
                
                passwords.forEach(pwd => {
                    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                    categories[pwd.category] = (categories[pwd.category] || 0) + 1;
                    
                    // –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
                    const strength = this.calculatePasswordStrength(pwd.password);
                    totalStrength += strength;
                });
                
                return {
                    total: passwords.length,
                    categories: categories,
                    averageStrength: passwords.length > 0 ? Math.round(totalStrength / passwords.length) : 0,
                    lastUpdate: passwords.length > 0 
                        ? new Date(passwords[0].updatedAt || passwords[0].createdAt).toLocaleDateString('ru-RU')
                        : '–Ω–∏–∫–æ–≥–¥–∞'
                };
            }

            calculatePasswordStrength(password) {
                if (!password) return 0;
                
                let score = 0;
                
                // –î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è
                if (password.length >= 12) score += 30;
                else if (password.length >= 8) score += 20;
                else if (password.length >= 6) score += 10;
                
                // –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–∏–º–≤–æ–ª–æ–≤
                if (/[a-z]/.test(password)) score += 10;
                if (/[A-Z]/.test(password)) score += 15;
                if (/[0-9]/.test(password)) score += 15;
                if (/[^a-zA-Z0-9]/.test(password)) score += 20;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏
                const commonPasswords = ['123456', 'password', 'qwerty', '12345678', '123456789'];
                if (!commonPasswords.includes(password.toLowerCase())) score += 10;
                
                return Math.min(score, 100);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–∞—Ä–æ–ª–µ–π
        const passwordDB = new PasswordManagerDB();
        let currentCategory = 'all';

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, duration = 3000) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -20px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
        async function displayPasswords() {
            try {
                const passwords = await passwordDB.getPasswords(currentCategory);
                const passwordList = document.getElementById('passwordList');
                const emptyState = document.getElementById('emptyState');
                
                passwordList.innerHTML = '';
                
                if (passwords.length === 0) {
                    emptyState.style.display = 'block';
                    passwordList.style.display = 'none';
                    return;
                }
                
                emptyState.style.display = 'none';
                passwordList.style.display = 'flex';
                
                passwords.forEach(password => {
                    const categoryNames = {
                        social: '–°–æ—Ü—Å–µ—Ç–∏',
                        email: '–ü–æ—á—Ç–∞',
                        games: '–ò–≥—Ä—ã',
                        finance: '–§–∏–Ω–∞–Ω—Å—ã',
                        work: '–†–∞–±–æ—Ç–∞',
                        other: '–î—Ä—É–≥–æ–µ'
                    };
                    
                    const card = document.createElement('div');
                    card.className = 'password-card';
                    card.innerHTML = `
                        <div class="password-header">
                            <div class="service-name">${escapeHtml(password.service)}</div>
                            <div class="category-badge">${categoryNames[password.category] || password.category}</div>
                        </div>
                        <div class="password-field">
                            <span class="field-label">–õ–æ–≥–∏–Ω</span>
                            <div class="field-value" id="username-${password.id}">${escapeHtml(password.username)}</div>
                        </div>
                        <div class="password-field">
                            <span class="field-label">–ü–∞—Ä–æ–ª—å</span>
                            <div class="field-value" id="password-${password.id}" style="filter: blur(5px); user-select: none;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                        </div>
                        ${password.notes ? `
                        <div class="password-field">
                            <span class="field-label">–ó–∞–º–µ—Ç–∫–∏</span>
                            <div class="field-value">${escapeHtml(password.notes)}</div>
                        </div>
                        ` : ''}
                        <div class="password-actions">
                            <button class="action-btn" onclick="showPassword(${password.id})">
                                üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å
                            </button>
                            <button class="action-btn copy" onclick="copyToClipboard('${escapeHtml(password.password)}', '–ø–∞—Ä–æ–ª—å')">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    `;
                    
                    passwordList.appendChild(card);
                });
            } catch (error) {
                console.error('Error displaying passwords:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä–æ–ª–µ–π');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å
        function showPassword(id) {
            const passwordEl = document.getElementById(`password-${id}`);
            const button = event.target.closest('button');
            
            if (passwordEl.style.filter === 'blur(5px)') {
                // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                passwordDB.getPasswords('all').then(passwords => {
                    const password = passwords.find(p => p.id === id);
                    if (password) {
                        passwordEl.style.filter = 'none';
                        passwordEl.textContent = password.password;
                        button.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è –°–∫—Ä—ã—Ç—å';
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
                        setTimeout(() => {
                            if (passwordEl.style.filter === 'none') {
                                passwordEl.style.filter = 'blur(5px)';
                                passwordEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                                button.innerHTML = 'üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å';
                            }
                        }, 30000);
                    }
                });
            } else {
                passwordEl.style.filter = 'blur(5px)';
                passwordEl.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                button.innerHTML = 'üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å';
            }
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard(text, type) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!`);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
        function showAddForm() {
            document.getElementById('addModal').style.display = 'flex';
            tg.BackButton.show();
            tg.BackButton.onClick(hideAddForm);
        }

        function hideAddForm() {
            document.getElementById('addModal').style.display = 'none';
            tg.BackButton.hide();
            document.getElementById('passwordForm').reset();
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
        function generatePassword() {
            const length = 16;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?";
            let password = "";
            
            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
            password += getRandomChar("abcdefghijklmnopqrstuvwxyz");
            password += getRandomChar("ABCDEFGHIJKLMNOPQRSTUVWXYZ");
            password += getRandomChar("0123456789");
            password += getRandomChar("!@#$%^&*()_+-=[]{}|;:,.<>?");
            
            // –î–æ–±–∏–≤–∞–µ–º –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã
            for (let i = 4; i < length; i++) {
                password += getRandomChar(charset);
            }
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
            password = password.split('').sort(() => Math.random() - 0.5).join('');
            
            document.getElementById('password').value = password;
            document.getElementById('password').type = 'text';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        }

        function getRandomChar(charset) {
            return charset[Math.floor(Math.random() * charset.length)];
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const service = document.getElementById('serviceName').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const category = document.getElementById('category').value;
            const url = document.getElementById('url').value.trim();
            const notes = document.getElementById('notes').value.trim();
            
            if (!service || !username || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const passwordData = {
                    service,
                    username,
                    password,
                    category,
                    url: url || null,
                    notes: notes || null
                };
                
                await passwordDB.savePassword(passwordData);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        command: 'password_added',
                        service: service,
                        category: category,
                        timestamp: new Date().toISOString()
                    }));
                }
                
                showNotification('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                hideAddForm();
                displayPasswords();
                
            } catch (error) {
                console.error('Error saving password:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.dataset.category;
                displayPasswords();
            });
        });

        // –≠–∫—Å–ø–æ—Ä—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        async function exportEncrypted() {
            try {
                const passwords = await passwordDB.getPasswords('all');
                const stats = await passwordDB.getStats();
                
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    statistics: stats,
                    passwords: passwords
                };
                
                // –ü—Ä–æ—Å—Ç–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ)
                const dataStr = JSON.stringify(exportData, null, 2);
                const encrypted = btoa(unescape(encodeURIComponent(dataStr)));
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                downloadFile(encrypted, 'passwords_encrypted.json', 'application/json');
                
                showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        command: 'export_complete',
                        export_time: new Date().toISOString(),
                        item_count: stats.total,
                        type: 'encrypted'
                    }));
                }
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –ù–ï—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏)
        async function exportUnencrypted() {
            try {
                const passwords = await passwordDB.getPasswords('all');
                const stats = await passwordDB.getStats();
                
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    statistics: stats,
                    passwords: passwords.map(p => ({
                        service: p.service,
                        username: p.username,
                        password: p.password, // –ü–∞—Ä–æ–ª–∏ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ!
                        category: p.category,
                        url: p.url,
                        notes: p.notes,
                        createdAt: p.createdAt,
                        updatedAt: p.updatedAt
                    }))
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                downloadFile(dataStr, 'passwords_unencrypted.json', 'application/json');
                
                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                showNotification('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü–∞—Ä–æ–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ë–ï–ó —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è!');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        command: 'export_complete',
                        export_time: new Date().toISOString(),
                        item_count: stats.total,
                        type: 'unencrypted',
                        warning: '–ü–∞—Ä–æ–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –±–µ–∑ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è!'
                    }));
                }
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async function showStats() {
            try {
                const stats = await passwordDB.getStats();
                const passwords = await passwordDB.getPasswords('all');
                
                let message = `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä–æ–ª–µ–π\n\n`;
                message += `–í—Å–µ–≥–æ –ø–∞—Ä–æ–ª–µ–π: ${stats.total}\n`;
                message += `–°—Ä–µ–¥–Ω—è—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: ${stats.averageStrength}%\n`;
                message += `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${stats.lastUpdate}\n\n`;
                message += `üìÅ –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n`;
                
                for (const [category, count] of Object.entries(stats.categories)) {
                    const categoryNames = {
                        social: '–°–æ—Ü—Å–µ—Ç–∏',
                        email: '–ü–æ—á—Ç–∞',
                        games: '–ò–≥—Ä—ã',
                        finance: '–§–∏–Ω–∞–Ω—Å—ã',
                        work: '–†–∞–±–æ—Ç–∞',
                        other: '–î—Ä—É–≥–æ–µ'
                    };
                    message += `${categoryNames[category] || category}: ${count}\n`;
                }
                
                // –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                message += `\nüîê –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:\n`;
                if (stats.total === 0) {
                    message += `–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\n`;
                } else if (stats.averageStrength < 50) {
                    message += `‚ö†Ô∏è  –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n`;
                    message += `–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–ª—É—á—à–∏—Ç—å –ø–∞—Ä–æ–ª–∏\n`;
                } else if (stats.averageStrength < 75) {
                    message += `‚úÖ –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n`;
                } else {
                    message += `üéâ –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!\n`;
                }
                
                alert(message);
                
            } catch (error) {
                console.error('Stats error:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        }

        // –ú–µ–Ω—é —ç–∫—Å–ø–æ—Ä—Ç–∞
        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
            setTimeout(() => {
                const closeHandler = (e) => {
                    if (!e.target.closest('.export-menu')) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeHandler);
                    }
                };
                document.addEventListener('click', closeHandler);
            }, 0);
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await passwordDB.init();
                await displayPasswords();
                console.log('App initialized successfully');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ (—Ä–∞–∑ –≤ 30 –¥–Ω–µ–π)
                const lastBackup = localStorage.getItem('lastBackup');
                const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                
                if (!lastBackup || parseInt(lastBackup) < thirtyDaysAgo) {
                    showNotification('üíæ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é', 5000);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –±–æ—Ç
                    if (tg && tg.sendData) {
                        tg.sendData(JSON.stringify({
                            command: 'backup_reminder',
                            days_since_backup: lastBackup 
                                ? Math.floor((Date.now() - parseInt(lastBackup)) / (24 * 60 * 60 * 1000))
                                : 999
                        }));
                    }
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideAddForm();
                document.getElementById('exportDropdown').classList.remove('show');
            }
        });
    </script>
</body>
</html>
